<!-- Error Alert -->
@if (error()) {
  <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ error() }}
    <button type="button" class="btn btn-sm btn-outline-danger ms-3" (click)="retryLoad()">
      <i class="bi bi-arrow-clockwise me-1"></i>Retry
    </button>
    <button type="button" class="btn-close" (click)="error.set(null)" aria-label="Close"></button>
  </div>
}

<!-- Loading Overlay -->
@if (isLoading()) {
  <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
       style="background: rgba(0,0,0,0.3); z-index: 9999;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Users Management</h2>
    <p class="text-muted mb-0">Manage and monitor all system users</p>
  </div>
@if (permissions().canCreateUser) {
  <button 
    class="btn btn-primary"
    (click)="onAddUser()"
    [disabled]="isLoading()">
    <i class="bi bi-plus-circle me-2"></i>Add New User
  </button>
}
</div>

<!-- Search & Filter Card -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form (submit)="onSearch($event)" aria-label="User search form">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="searchCategory" class="form-label fw-semibold">
            <i class="bi bi-funnel me-1" aria-hidden="true"></i>Category
          </label>
          <select 
            id="searchCategory" 
            [ngModel]="searchCategory()"
            (ngModelChange)="onCategoryChange($event)"
            name="category" 
            class="form-select"
            [disabled]="isLoading()"
        aria-label="Filter by category">
            <option value="">All Categories</option>
            <option value="Admin">Admin</option>
            <option value="User">User</option>
            <option value="Guest">Guest</option>
            <option value="Manager">Manager</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="searchInput" class="form-label fw-semibold">
            <i class="bi bi-search me-1" aria-hidden="true"></i>Search
          </label>
          <input 
            id="searchInput" 
            type="text" 
            [ngModel]="searchText()"
            (ngModelChange)="onSearchTextChange($event)"
            name="searchText" 
            class="form-control" 
            placeholder="Search by name or email..."
            [disabled]="isLoading()"
            maxlength="100"
            aria-label="Search users by name or email">
        </div>

        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100" [disabled]="isLoading()"
        aria-label="Submit search">
        <i class="bi bi-search me-2" aria-hidden="true"></i>Search
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Results Summary -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <span class="text-muted">
      @if (totalItems() > 0) {
        Showing {{ (currentPage() - 1) * itemsPerPage() + 1 }} to {{ Math.min(currentPage() * itemsPerPage(), totalItems()) }} of {{ totalItems() }} entries
      } @else {
        No entries found
      }
    </span>
  </div>
  <div class="d-flex gap-2">
    <select 
      class="form-select form-select-sm" 
      style="width: auto;" 
      [ngModel]="itemsPerPage()"
      (ngModelChange)="onItemsPerPageChange($event)"
      [disabled]="isLoading()">
      <option [value]="5">5 per page</option>
      <option [value]="10">10 per page</option>
      <option [value]="25">25 per page</option>
      <option [value]="50">50 per page</option>
    </select>
  </div>
</div>

<!-- Table Card -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0"aria-label="Users list">
        <thead class="table-light">
          <tr>
            <th class="px-4">#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Roles</th>
            <th class="text-center">Status</th>
            <th class="text-end px-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.id; let i = $index) { 
            <tr class="border-bottom">
              <td class="px-4 text-muted">{{ (currentPage() - 1) * itemsPerPage() + i + 1 }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-circle me-2" aria-hidden="true">
                    {{ (user.name ?? 'Unknown').charAt(0).toUpperCase() }}
                  </div>
                  <span class="fw-medium">{{ user.name ?? 'Unknown User' }}</span>
                </div>
              </td>
              <td class="text-muted">{{ user.email }}</td>
              <td>
                <!-- Handle array of roles -->
                @for (role of user.roles; track role) {
                  <span 
                    class="badge rounded-pill me-1"
                    [ngClass]="{
                      'bg-danger': role === 'Admin',
                      'bg-primary': role === 'User',
                      'bg-secondary': role === 'Guest',
                      'bg-info': role === 'Manager'
                    }"
              [attr.aria-label]="'User role: ' + role">
                    {{ role }}
                  </span>
                }
              </td>
              <td class="text-center">
                <span 
                  class="badge"
                  [ngClass]="{
                    'bg-success-subtle text-success border border-success': user.status === 'Active',
                    'bg-danger-subtle text-danger border border-danger': user.status === 'Inactive'
                  }"
            [attr.aria-label]="'User status: ' + user.status">
                  <i class="bi me-1" 
                     [ngClass]="{
                       'bi-check-circle-fill': user.status === 'Active',
                       'bi-x-circle-fill': user.status === 'Inactive'
                     }"aria-hidden="true"></i>
                  {{ user.status }}
                </span>
              </td>
         @if (permissions().canEditUser || permissions().canDeleteUser) {
          <td role="cell" class="text-end px-4">
            <div class="btn-group btn-group-sm" role="group" aria-label="User actions">
              @if (permissions().canEditUser) {
                <button 
                  (click)="onEditUser(user)"
                  class="btn btn-outline-primary"
                  aria-label="Edit {{ user.name ?? user.email }}">
                  <i class="bi bi-pencil" aria-hidden="true"></i>
                  Edit
                </button>
              }
              @if (permissions().canDeleteUser) {
                <button 
                  (click)="onDeleteUser(user)"
                  class="btn btn-outline-danger"
                  aria-label="Delete {{ user.name ?? user.email }}">
                  <i class="bi bi-trash" aria-hidden="true"></i>
                  Delete
                </button>
              }
            </div>
          </td>
        }
      </tr>
    } @empty {
      @if (!isLoading()) {
        <tr>
          <td colspan="6" class="text-center py-5" role="cell">
            <div class="text-muted">
              <i class="bi bi-inbox fs-1 d-block mb-2" aria-hidden="true"></i>
              <p class="mb-0">No records found</p>
              @if (searchText() || searchCategory()) {
                <p class="small">Try adjusting your search filters</p>
              }
            </div>
          </td>
        </tr>
      }
    }
  </tbody>
</table>

<!-- Pagination -->
@if (totalItems() > itemsPerPage()) {
  <nav aria-label="User list pagination" class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage() === 1 || isLoading()">
        <a 
          class="page-link" 
          href="#" 
          (click)="pageChanged($event, currentPage() - 1)"
          [attr.aria-label]="'Go to previous page'"
          [attr.aria-disabled]="currentPage() === 1 || isLoading()">
          <i class="bi bi-chevron-left" aria-hidden="true"></i>
          <span class="visually-hidden">Previous</span>
        </a>
      </li>
      @for (page of pageNumbers(); track page) {
        @if (page === '...') {
          <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">...</span>
          </li>
        } @else {
          <li
            class="page-item"
            [class.active]="currentPage() === page"
            [class.disabled]="isLoading()">
            <a 
              class="page-link" 
              href="#" 
              (click)="pageChanged($event, page)"
              [attr.aria-label]="'Go to page ' + page"
              [attr.aria-current]="currentPage() === page ? 'page' : null">
              {{ page }}
            </a>
          </li>
        }
      }
      <li class="page-item" [class.disabled]="currentPage() === totalPages() || isLoading()">
        <a 
          class="page-link" 
          href="#" 
          (click)="pageChanged($event, currentPage() + 1)"
          [attr.aria-label]="'Go to next page'"
          [attr.aria-disabled]="currentPage() === totalPages() || isLoading()">
          <i class="bi bi-chevron-right" aria-hidden="true"></i>
          <span class="visually-hidden">Next</span>
        </a>
      </li>
    </ul>
  </nav>
}